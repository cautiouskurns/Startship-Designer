# F-AI-009: Synergy Exploitation

**Status:** ðŸ”´ Planned
**Priority:** â¬†ï¸ High
**Estimated Time:** 2 days
**Dependencies:** F-AI-003 (Basic Doctrine System)
**Phase:** 3 - Advanced Behaviors

---

## Purpose

**Why does this feature exist?**
Ships with synergies (Shield Harmonics, Weapons Array, Engine Network) should leverage them intelligently. AI should recognize its own synergies and adjust targeting to protect them, and recognize enemy synergies to prioritize disrupting them.

**What does it enable?**
AI with Shield Harmonics defends its shield clusters aggressively. AI facing enemy Weapons Array targets the array to break the synergy. Different synergy compositions create different AI behaviors and tactical priorities.

**Success criteria:**
- AI correctly identifies its own active synergies 100% of the time
- AI prioritizes protecting synergy rooms when under threat
- AI targets enemy synergy rooms when opponent has active synergies
- Synergy-aware AI wins 15%+ more often than synergy-blind AI (in simulation)

---

## How It Works

### Overview

The system detects active synergies on both ships and adjusts AI behavior:

**Defensive (protecting our synergies):**
- If we have Shield Harmonics: Increase defensive priority, protect shield cluster
- If we have Weapons Array: Adopt aggressive stance, maximize damage while array intact
- If we have Engine Network: Value initiative highly, protect engine cluster

**Offensive (disrupting enemy synergies):**
- If enemy has Shield Harmonics: Target shields to break synergy, reduce their defense
- If enemy has Weapons Array: Target weapons to break synergy, reduce their offense
- If enemy has Engine Network: Target engines to remove initiative advantage

Synergy awareness modifies threat scores, doctrine weights, and target priorities.

### User Flow
```
1. Combat starts â†’ ShipProfile contains synergy_count{} (from F-AI-001)
2. SynergyExploitation.analyze_synergies(our_profile, enemy_profile) called
3. System identifies active synergies for both ships
4. System generates SynergyStrategy:
   a. Defensive priorities (protect our synergies)
   b. Offensive priorities (disrupt enemy synergies)
5. SynergyStrategy passed to targeting systems (F-AI-006)
6. Threat scores adjusted:
   - Our synergy rooms: +20 defensive priority (avoid losing them)
   - Enemy synergy rooms: +30 offensive priority (target to disrupt)
7. Combat log: "Enemy has Weapons Array - Targeting weapons to break synergy"
```

### Rules & Constraints

**Synergy Detection:**

From ShipProfile.synergy_count (F-AI-001):
```
synergy_count = {
    SynergyType.SHIELD_HARMONICS: 0-3,  # Count of shield synergy clusters
    SynergyType.WEAPONS_ARRAY: 0-2,     # Count of weapon synergy clusters
    SynergyType.ENGINE_NETWORK: 0-2,    # Count of engine synergy clusters
    SynergyType.POWER_EFFICIENCY: 0-1   # Binary: reactor efficiency synergy
}

Active synergy = synergy_count[type] > 0
```

**Defensive Synergy Priorities:**

**If we have Shield Harmonics:**
- Reduce aggression by 0.1 (play more defensively)
- Increase target priority for enemy weapons by +15 (reduce incoming damage to protect shields)
- Doctrine shift: Even Alpha Strike plays more conservatively

**If we have Weapons Array:**
- Increase aggression by 0.15 (maximize damage while array intact)
- Increase target priority for enemy shields by +10 (ensure our weapons remain effective)
- Doctrine shift: Even Turtle becomes more aggressive

**If we have Engine Network:**
- Prioritize maintaining initiative (target enemy engines +10)
- Value speed advantage (early strikes before enemy can retaliate)

**If we have Power Efficiency:**
- Less vulnerable to reactor loss (redundancy)
- Slightly reduce reactor defensive priority (can afford to lose one)

**Offensive Synergy Disruption:**

**If enemy has Shield Harmonics:**
- Target enemy shields with +30 priority (break synergy)
- Log reasoning: "Enemy Shield Harmonics detected - Targeting shields to disrupt"
- Effect: Breaking 1 shield reduces all shield effectiveness (synergy broken)

**If enemy has Weapons Array:**
- Target enemy weapons with +30 priority (break synergy)
- Log reasoning: "Enemy Weapons Array detected - Targeting weapons to disrupt"
- Effect: Breaking 1 weapon reduces all weapon effectiveness (synergy broken)

**If enemy has Engine Network:**
- Target enemy engines with +25 priority (remove initiative advantage)
- Log reasoning: "Enemy Engine Network detected - Targeting engines to slow them"

**If enemy has Power Efficiency:**
- Slightly increase reactor priority (+5) (still valuable, but less impactful)

**Synergy Priority Stacking:**
```
final_priority = base_threat_score + doctrine_weight + synergy_modifier

Example:
- Enemy weapon base threat = 30
- Doctrine (Alpha Strike) weight Ã— 1.0 = 30
- Enemy Weapons Array synergy modifier = +30
- Final priority = 30 + 30 = 60 (very high priority)

vs

- Enemy armor base threat = 5
- Doctrine (Alpha Strike) weight Ã— 0.1 = 0.5
- No synergy modifier = +0
- Final priority = 5 + 0.5 = 5.5 (very low priority)
```

**Synergy Breaking Detection:**
```
# Real-time during combat
if room_destroyed.type == WEAPON and enemy_has_weapons_array:
    weapons_remaining = count_enemy_weapons()
    if weapons_remaining < WEAPONS_ARRAY_MIN_THRESHOLD:
        synergy_broken = true
        log_entry("Enemy Weapons Array synergy broken!")

# Weapons Array requires 3+ weapons
# Shield Harmonics requires 3+ shields
# Engine Network requires 3+ engines
```

### Edge Cases

**Multiple synergies active (our ship):**
- Example: Shield Harmonics + Weapons Array
- Defensive: Protect shields (Harmonics) AND be aggressive (Array)
- Resolution: Balanced approach, slightly favor offense (Array aggression dominant)

**Multiple enemy synergies:**
- Example: Enemy has Weapons Array + Shield Harmonics
- Offensive: Disrupt both synergies
- Resolution: Prioritize based on our doctrine (Alpha Strike targets weapons, Turtle targets weapons to reduce threat)

**Synergy breaks mid-combat:**
- Enemy had Weapons Array (3 weapons), we destroyed 1 weapon
- 2 weapons remain â†’ synergy broken
- System recalculates priorities: reduce synergy bonus, revert to normal targeting

**We have synergy, enemy doesn't:**
- Defensive priorities active (protect our synergy)
- No offensive synergy disruption (enemy has none to disrupt)
- Result: Play to our strengths, leverage synergy advantage

**Neither ship has synergies:**
- SynergyExploitation returns neutral strategy (no modifiers)
- Targeting proceeds with normal threat/doctrine scoring

**Synergy cluster partially destroyed:**
- Shield Harmonics requires 3+ shields, we have 4, lost 1 â†’ still active (3 remaining)
- Continue defensive priorities (synergy still intact)
- If lose 1 more â†’ synergy breaks, priorities revert

---

## User Interaction

### Controls
None (automatic synergy detection and exploitation)

### Visual Feedback
- Combat log shows synergy awareness: "We have Shield Harmonics - Playing defensively"
- Combat log shows synergy disruption: "Enemy Weapons Array disrupted - Synergy broken!"
- Thought bubbles (F-AI-013) reference synergies: "Their weapon synergy is dangerous!"

### Audio Feedback
None (optional: synergy break sound effect in polish)

---

## Visual Design

### Layout
No direct UI (data structure only)

### Components
N/A - Backend system

### Visual Style
N/A

### States
- **Analyzing:** During synergy detection
- **Active:** Synergy strategy influencing decisions
- **Synergy Broken:** Enemy synergy disrupted, priorities updated

---

## Technical Implementation

### Scene Structure
```
No new scenes (pure logic)
```

### Script Responsibilities

**New File: `scripts/ai/SynergyExploitation.gd`**
- Analyzes active synergies and generates strategy
- Methods:
  - analyze_synergies(our_profile: ShipProfile, enemy_profile: ShipProfile) -> SynergyStrategy
  - get_defensive_modifiers(our_synergies: Dictionary) -> Dictionary
  - get_offensive_modifiers(enemy_synergies: Dictionary) -> Dictionary
  - is_synergy_active(synergy_type: SynergyType, count: int) -> bool
  - check_synergy_broken(ship: ShipData, synergy_type: SynergyType) -> bool
- Returns SynergyStrategy with defensive and offensive priority modifiers

**New File: `scripts/ai/SynergyStrategy.gd`**
- Data class holding synergy-based strategy
- Properties:
  - our_active_synergies: Array[SynergyType]
  - enemy_active_synergies: Array[SynergyType]
  - defensive_priorities: Dictionary {RoomType: float}  # Protect our rooms
  - offensive_priorities: Dictionary {RoomType: float}  # Target enemy rooms
  - aggression_modifier: float  # Adjust overall aggression
- Methods: to_string() â†’ summary of synergy strategy

**Modified: `scripts/ai/TargetScoring.gd` (F-AI-006)**
- Accept SynergyStrategy as input parameter
- Apply synergy offensive priorities to threat scores
- Example: final_score += synergy_strategy.offensive_priorities[room.type]

**Modified: `scripts/ai/Doctrine.gd` (F-AI-003)**
- Apply synergy defensive priorities to doctrine weights
- Adjust aggression_level based on synergy_strategy.aggression_modifier

**Modified: `scripts/combat/Combat.gd`**
- Call SynergyExploitation.analyze_synergies() at combat start
- Pass SynergyStrategy to targeting and doctrine systems
- Monitor synergy breaks (when rooms destroyed) and recalculate

**Modified: `scripts/ui/CombatLog.gd` (F-AI-004)**
- Add synergy awareness entries at combat start
- Add synergy broken entries when thresholds crossed

### Data Structures

```gdscript
class_name SynergyStrategy

var our_active_synergies: Array[SynergyType] = []
var enemy_active_synergies: Array[SynergyType] = []

# Defensive priorities (protect our synergy rooms)
var defensive_priorities: Dictionary = {
    RoomData.RoomType.WEAPON: 0.0,
    RoomData.RoomType.SHIELD: 0.0,
    RoomData.RoomType.ENGINE: 0.0,
    RoomData.RoomType.REACTOR: 0.0
}

# Offensive priorities (target enemy synergy rooms)
var offensive_priorities: Dictionary = {
    RoomData.RoomType.WEAPON: 0.0,
    RoomData.RoomType.SHIELD: 0.0,
    RoomData.RoomType.ENGINE: 0.0,
    RoomData.RoomType.REACTOR: 0.0
}

var aggression_modifier: float = 0.0  # Â±0.15 adjustment

func has_our_synergy(synergy_type: SynergyType) -> bool:
    return our_active_synergies.has(synergy_type)

func has_enemy_synergy(synergy_type: SynergyType) -> bool:
    return enemy_active_synergies.has(synergy_type)
```

### Integration Points

**Connects to:**
- ShipProfile (F-AI-001): Reads synergy_count{}
- TargetScoring (F-AI-006): Modifies threat scores with offensive priorities
- Doctrine (F-AI-003): Adjusts aggression and defensive priorities
- Combat log (F-AI-004): Synergy awareness and break notifications
- ShipData: Monitors room counts for synergy break detection

**Emits signals:**
- synergy_broken(ship: String, synergy_type: SynergyType) - when synergy threshold crossed

**Listens for:**
- room_destroyed signal (to check if synergy broken)

**Modifies:**
- Threat scores in TargetScoring
- Aggression levels in Doctrine

### Configuration

**Tunable Constants in `BalanceConstants.gd`:**
```gdscript
# Synergy thresholds (from game design)
const SYNERGY_WEAPONS_ARRAY_MIN = 3  # Need 3+ weapons
const SYNERGY_SHIELD_HARMONICS_MIN = 3  # Need 3+ shields
const SYNERGY_ENGINE_NETWORK_MIN = 3  # Need 3+ engines

# Defensive synergy modifiers
const SYNERGY_SHIELD_HARMONICS_AGGRESSION_REDUCTION = -0.1
const SYNERGY_SHIELD_HARMONICS_WEAPON_PRIORITY = 15.0
const SYNERGY_WEAPONS_ARRAY_AGGRESSION_INCREASE = 0.15
const SYNERGY_WEAPONS_ARRAY_SHIELD_PRIORITY = 10.0
const SYNERGY_ENGINE_NETWORK_ENGINE_PRIORITY = 10.0

# Offensive synergy disruption bonuses
const SYNERGY_DISRUPT_SHIELD_HARMONICS_BONUS = 30.0
const SYNERGY_DISRUPT_WEAPONS_ARRAY_BONUS = 30.0
const SYNERGY_DISRUPT_ENGINE_NETWORK_BONUS = 25.0
const SYNERGY_DISRUPT_POWER_EFFICIENCY_BONUS = 5.0
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] SynergyExploitation correctly detects our active synergies from ShipProfile
- [ ] SynergyExploitation correctly detects enemy active synergies from ShipProfile
- [ ] Shield Harmonics (ours) reduces aggression by 0.1 and increases weapon target priority by +15
- [ ] Weapons Array (ours) increases aggression by 0.15 and increases shield target priority by +10
- [ ] Engine Network (ours) increases enemy engine target priority by +10
- [ ] Shield Harmonics (enemy) adds +30 to enemy shield target priority
- [ ] Weapons Array (enemy) adds +30 to enemy weapon target priority
- [ ] Engine Network (enemy) adds +25 to enemy engine target priority
- [ ] Synergy break detection correctly identifies when room count falls below threshold
- [ ] Combat log shows synergy awareness at combat start
- [ ] Combat log shows synergy broken notification when threshold crossed
- [ ] Synergy-aware AI demonstrates measurably different targeting vs synergy-blind AI

---

## Testing Checklist

### Functional Tests
- [ ] **Our ship: Shield Harmonics (3+ shields)**: Aggression reduced, target enemy weapons +15 priority
- [ ] **Our ship: Weapons Array (3+ weapons)**: Aggression increased, target enemy shields +10 priority
- [ ] **Enemy: Weapons Array (3 weapons)**: Enemy weapons get +30 target priority
- [ ] **Enemy: Weapons Array, destroy 1 weapon**: Synergy breaks at 2 weapons, log shows "Synergy broken!"

### Edge Case Tests
- [ ] **Both ships have Shield Harmonics**: Defensive and offensive priorities both active
- [ ] **Enemy has Weapons Array + Shield Harmonics**: Both get +30 disruption bonus
- [ ] **No synergies on either ship**: SynergyStrategy neutral (no modifiers)
- [ ] **Synergy cluster partially destroyed (4 shields â†’ 3)**: Synergy still active (threshold = 3)

### Integration Tests
- [ ] Works with ShipProfile (F-AI-001) for synergy detection
- [ ] Works with TargetScoring (F-AI-006) for priority modifications
- [ ] Works with Doctrine (F-AI-003) for aggression adjustments
- [ ] Combat log shows synergy entries correctly
- [ ] Synergy break signal emitted when threshold crossed

### Polish Tests
- [ ] Synergy analysis causes no noticeable lag
- [ ] Synergy-aware AI wins more often than synergy-blind AI (A/B testing)
- [ ] Combat log synergy messages clear and understandable
- [ ] Players can learn synergy value by watching AI (playtester validation)

---

## Known Limitations

- **Binary synergy detection:** Either active or not (no partial synergy scaling)
- **Static thresholds:** Synergy breaks at fixed counts (3 weapons), not percentage-based
- **No synergy prediction:** Doesn't anticipate "if enemy destroys 1 more shield, I lose Harmonics"
- **Simple disruption logic:** Targets synergy rooms equally (doesn't identify most critical room in cluster)

---

## Future Enhancements

*(Not for MVP)*

- Graduated synergy scaling: Synergy strength scales with room count (4 shields > 3 shields)
- Predictive synergy defense: Anticipate synergy loss and protect critical rooms preemptively
- Targeted synergy disruption: Identify keystone room in synergy cluster (most connected)
- Synergy combos: Detect powerful synergy combinations (Harmonics + Array = ultra-defensive aggression)
- Dynamic synergy formation: AI actively builds synergies during power management (F-AI-010)

---

## Implementation Notes

**Code Reuse:**
- Synergy detection reuses ShipProfile.synergy_count from F-AI-001
- Priority modification reuses TargetScoring framework from F-AI-006
- Room counting reuses ShipData methods

**Performance:**
- Synergy analysis runs once at combat start (cached)
- Synergy break check only when room destroyed (not every turn)
- Simple dictionary lookups for priority modifiers (O(1))

**Compatibility:**
- Synergy modifiers stack with threat scores and doctrine weights (additive)
- Can be disabled via flag for A/B testing
- Synergy-blind AI can coexist with synergy-aware AI (backward compatible)

**Design Philosophy:**
- Synergies should feel *powerful* when leveraged correctly
- AI demonstrates synergy value through intelligent play
- Synergy disruption creates tactical depth (rock-paper-scissors dynamics)
- Players learn synergy strategies by watching AI exploit them

---

## Change Log

| Date | Change | Reason |
|------|--------|--------|
| Dec 10 2025 | Initial spec | Feature planned |
